(function(){var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};(function(exports){var AttributeWriter,Binder,Binding,ChangeHandler,ElementWriter,Formatter,Writer,get_nested_value;return get_nested_value=function(e,t){var n,r,i,s;s=t.split(".");for(r=0,i=s.length;r<i;r++){n=s[r],e=e[n];if(e==null)return null}return e},Binding=function(){function e(e,t){this.bindings=e,this.writer=t,_.extend(this,ChangeHandler)}return e.parse=function(t,n){return t.split(";").map(function(t){var r,i,s,o,u,a,f,l,c;l=/^ *(\[([^\]]+)\] *)?(.*)$/.exec(t),f=l[0],f=l[1],r=l[2],s=l[3],c=s.split("->"),i=c[0],o=c[1],i=i.split(",");if(i.length>1&&o==null)throw new Error("Multiple events require a formatter: "+t);return i=i.map(function(e){var t,r,i;return e=e.trim(),e[0]==="@"?(t=!0,r=e.split(":")[0].slice(1),e=e.slice(r.length+2)):(t=!1,i=e.split(":"),r=i[0],e=i[1],e==null&&(e=r,r="model")),{global:t,object:r,event:e,view:n}}),u=new Formatter(i,o),a=r!=null?new AttributeWriter(u,r):new ElementWriter(u),new e(i,a)})},e.parse_element=function(e,t){var n,r;return r=$(e).data().bind,$(e).attr("data-bind",null),n=this.parse(r,t),n.map(function(t){return t.el=e}),n},e.prototype.bind=function(e,t){var n,r,i,s;if(this.bound_view!=null)return;this.bound_view=t,s=this.bindings;for(r=0,i=s.length;r<i;r++)n=s[r],n.bound_object=get_nested_value(n.global?window:t,n.object),e.bind_to(n.bound_object);return this.write()},e.prototype.unbind=function(e){var t,n,r,i;i=this.bindings!=null;for(n=0,r=i.length;n<r;n++)t=i[n],e.unbind_from(t.bound_object);return this.bound_view=null},e.prototype.is_changed=function(e,t){return _(this.bindings).any(function(n){return n.bound_object===e&&_(t).any(function(e){return n.bound_object.has(e)})})},e.prototype.handle_change=function(){return this.write()},e.prototype.write=function(){var e,t=this;if(this.bound_view==null)return;return e=_(this.bindings).inject(function(e,t){return e[t.event]=t.bound_object.get(t.event),e},{}),this.writer.write(this.bound_view,this.el,e)},e}(),Formatter=function(){function Formatter(bindings,__format__){var _this=this;this.bindings=bindings;if(__format__==null)return this.format=function(e){return e[_this.bindings[0].event]},this;this.bindings.length===1?this.format=function(__values__){var current_view,source,__method__;current_view=_this.bindings[0].view,source=_this.bindings[0].bound_object,__method__="(function(value, "+_this.bindings[0].event+"){return "+__format__+"})(__values__['"+_this.bindings[0].event+"'], __values__['"+_this.bindings[0].event+"'])",_this.debug&&console.log(__method__);try{return eval(__method__)}catch(e){throw console.error(__method__),console.error(__values__),console.error(current_view),new Error("Could not format: ["+__format__+"] ERROR: "+e.message)}}:this.format=function(__values__){var current_view,sources,__args__,__method__,__value_args__;current_view=_this.bindings[0].view,sources=_this.bindings.map(function(e){return e.bound_object}),__args__=_this.bindings.map(function(e){return e.event}).join(", "),__value_args__=_this.bindings.map(function(e){return"__values__['"+e.event+"']"}).join(", "),__method__="(function("+__args__+"){return "+__format__+"})("+__value_args__+")",_this.debug&&console.log(__method__);try{return eval(__method__)}catch(e){throw console.error(__method__),console.error(__values__),new Error("Could not format: ["+__format__+"] ERROR: "+e.message)}}}return Formatter}(),Writer=function(){function e(){}return e.prototype.write=function(e,t,n){var r,i,s;return r=$(t),s=r.attr("bound-to"),i=(s||"").split(" ").concat(_(n).keys()).filter(function(e){return e!=null&&e!==""}),i=_(i).inject(function(e,t){return e[t]=1,e},{}),r.attr("bound-to",_(i).keys().join(" "))},e}(),ElementWriter=function(e){function t(e){this.formatter=e}return __extends(t,e),t.prototype.write=function(e,n,r){return t.__super__.write.apply(this,arguments),$(n).html(this.formatter.format(r))},t}(Writer),AttributeWriter=function(e){function t(e,t){this.formatter=e,this.attribute=t}return __extends(t,e),t.prototype.write=function(e,n,r){var i,s,o,u,a;t.__super__.write.apply(this,arguments),s=this.formatter.format(r),a=this.attribute.split(":"),u=a[0],i=a[1];if(i==null)return $(n).attr(this.attribute,s);if(u==="css")return o={},o[i]=s,$(n).css(o);if(u==="class")return s?$(n).addClass(i):$(n).removeClass(i);if(u==="prop")return $(n).prop(i,s)},t}(Writer),Binder=function(){function e(e,t){var n,r=this;this.view=e,t==null&&(t={}),_.extend(this,ChangeHandler),this.bound_events=[],this._render=this.view.render,this.view.render=this.render.bind(this),this._destroy=this.view.destroy,this.view.destroy=this.destroy.bind(this),this._unbind=this.view.unbind,this.view.unbind=this.unbind.bind(this),this.bindings=[],t.attributes!=null&&(n=this.bindings).push.apply(n,_(t.attributes.map(function(e){var t;return t=Binding.parse("["+e.set+"] "+e.from,r.view),t.map(function(e){return e.el=r.view.el}),t})).flatten()),this.replace_el=t.replace===!0}return e.hooks={},e.add_hook=function(e,t){var n,r;return((r=(n=this.hooks)[e])!=null?r:n[e]=[]).push(t)},e.apply_hooks=function(e,t){if(this.hooks[e]==null)return;return this.hooks[e].forEach(function(e){return e.call(t)})},e.initialize=function(t,n){return t.__binder__=new e(t,n)},e.unbind=function(e){if(e.__binder__==null)return;return e.__binder__.destroy()},e.prototype.destroy=function(){var e;return(e=this._destroy)!=null?e.apply(this.view,arguments):void 0},e.prototype.unbind=function(){var e,t,n,r,i,s,o,u,a;o=this.bindings;for(n=0,i=o.length;n<i;n++)e=o[n],e.unbind(this);u=this.bound_events;for(r=0,s=u.length;r<s;r++)t=u[r],$(t.el).off(t.event,t.callback);return(a=this._unbind)!=null?a.apply(this.view,arguments):void 0},e.prototype.bind=function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t.bind(this,this.view));return i},e.prototype.capture_data_bind_bindings=function(e){var t,n,r=this;return t=_(e.find("[data-bind]").toArray().map(function(e){return Binding.parse_element(e,r.view)})).flatten(),(n=this.bindings).push.apply(n,t),t},e.prototype.render_template=function(){var e;if(this.view.template!=null)return e=$(this.view.template({model:this.view.model})),this.replace_el?(this.view.$el.replaceWith(e),this.view.setElement(e)):this.view.$el.html(e)},e.prototype.render_data_event=function(e){var t=this;return e.find("[data-event]").each(function(e,n){var r,i,s,o,u,a,f,l,c,h;l=$(n).data("event").split(";"),h=[];for(a=0,f=l.length;a<f;a++){o=l[a],c=o.trim().split(":"),s=c[0],u=c[1],s=s.trim(),u=u.trim();if(s==null||u==null)throw new Error('data-event must be formatted like "event_name: view_method_name"');if(t.view[u]==null)throw new Error("[data-event] Method '"+u+"' does not exist in view");i=function(e){return function(){return t.view[e].apply(t.view,arguments)}},r=i(u),$(n).off(s,r),$(n).on(s,r),h.push(t.bound_events.push({el:n,event:s,callback:r}))}return h})},e.prototype.bind_to_dom=function(e){var t,n;return t=$(e),n=this.capture_data_bind_bindings(t),this.bind(n),this.render_data_event(t)},e.prototype.render=function(){return e.apply_hooks("before:render",this.view),this.render_template(),this.bind_to_dom(this.view.$el),this._render.apply(this.view,arguments),e.apply_hooks("after:render",this.view),this.view},e}(),ChangeHandler={bind_to:function(e){return e.off("change",this.on_change,this),e.on("change",this.on_change,this)},unbind_from:function(e){return e.off("change",this.on_change,this)},on_change:function(e,t){var n,r,i,s,o,u,a,f,l;i=_(t.changes||e.changes||e.changed).keys(),r=this.bindings.filter(function(t){return t.is_changed(e,i)});if(r.length===0)return;s=_(i).inject(function(t,n){return t[n]=e.get(n),t},{}),o=_(i).inject(function(t,n){return t[n]=e.previous(n),t},{}),typeof (u=this.view).before_change=="function"&&u.before_change(s,o);for(f=0,l=r.length;f<l;f++)n=r[f],n.handle_change();return typeof (a=this.view).after_change=="function"?a.after_change(s,o):void 0}},exports.Spellbinder=Binder})((typeof module!="undefined"&&module!==null?module.exports:void 0)||window)}).call(this);